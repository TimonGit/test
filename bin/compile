#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

function print_info() {
  echo "-----> $*"
}

function indent() {
  sed -u 's/^/       /'
}

INSTALL_DIR=$HOME/.appfirst
PACKAGE="https://www.dropbox.com/s/83oxhg14thgiwu7/distrodeb64.deb"
PACKAGE="https://www.dropbox.com/s/mkxhwp1hu6nxgty/collector.tar.xz"
PACKAGE_NAME=$(basename $PACKAGE .tar.xz)
PACKAGE_FILE=$INSTALL_DIR/$PACKAGE_NAME.tar.xz

mkdir -p $INSTALL_DIR
print_info "Downloading $PACKAGE"
print_info "Downloading $PACKAGE_NAME $PACKAGE_FILE"

echo "11476" > $HOME/tid.conf

curl -s -L -z $PACKAGE_FILE -o $PACKAGE_FILE $PACKAGE 2>&1 | indent
CURRENT_DIR=`pwd`
print_info "!!!!!! $CURRENT_DIR"
cd $INSTALL_DIR
tar xfv $PACKAGE_FILE
cd $CURRENT_DIR
rm -rf $PACKAGE_FILE
print_info "!!!!!!"
ls -la $HOME
print_info "!!!!!!"
print_info "Writing profile script"

#mkdir -p $HOME/.profile.d
print_info "!!!!!!1"

#if [ -f "$HOME/tid.conf" ]; then
#TID=`cat $HOME/tid.conf`
sed -i "/Tenant/c\   Tenant 11476" $HOME/.appfirst/etc/AppFirst.conf
#rm -rf $HOME/tid.conf
#fi
print_info "!!!!!!2"

cat $HOME/.appfirst/etc/AppFirst.conf
export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:\$HOME/.appfirst/usr/share/appfirst"
mkdir -p $HOME/.appfirst/var
mkdir -p $HOME/.appfirst/opt/data
export LD_PRELOAD="\$HOME/.appfirst/usr/share/appfirst/libwrap.so.1.0.1"

$HOME/.appfirst/usr/bin/collector --piddir="$HOME/.appfirst/var" --datadir="$HOME/.appfirst/opt/data"

