#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

function print_info() {
  echo "-----> $*"
}

function indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
INSTALL_DIR=$HOME/.appfirst
PACKAGE="https://www.dropbox.com/s/mkxhwp1hu6nxgty/collector.tar.xz"
PACKAGE_NAME=$(basename $PACKAGE .tar.xz)
PACKAGE_FILE=$INSTALL_DIR/$PACKAGE_NAME.tar.xz

mkdir -p $INSTALL_DIR
print_info "Downloading $PACKAGE"

curl -s -L -z $PACKAGE_FILE -o $PACKAGE_FILE $PACKAGE 2>&1 | indent
CURRENT_DIR=`pwd`
cd $INSTALL_DIR
tar xfv $PACKAGE_FILE
cd $CURRENT_DIR
rm -rf $PACKAGE_FILE

print_info "Writing profile script"

sed -i "/Tenant/c\   Tenant 11476" $INSTALL_DIR/etc/AppFirst.conf

cat $INSTALL_DIR/etc/AppFirst.conf
export LD_LIBRARY_PATH="$INSTALL_DIR/usr/share/appfirst:$LD_LIBRARY_PATH"
mkdir -p $INSTALL_DIR/var
mkdir -p $INSTALL_DIR/opt/data
export LD_PRELOAD="$INSTALL_DIR/usr/share/appfirst/libwrap.so.1.0.1"

#$INSTALL_DIR/usr/bin/collector --piddir="$INSTALL_DIR/var" --datadir="$INSTALL_DIR/opt/data"

echo $HOME
echo $INSTALL_DIR

/sbin/ifconfig -a
#mkdir -p $BUILD_DIR/.profile.d
#echo 'PATH=$PATH:$HOME/bin' > $BUILD_DIR/.profile.d/go.sh
#echo '' > $BUILD_DIR/.profile.d/go.sh
ps -A
echo "echo Hello1!" > $HOME/start1.sh
echo "command: ./start1.sh" > $HOME/Procfile
chmod 0777 $HOME/start1.sh
ls -la $HOME
echo "ps -A" > $1/start2.sh
#echo "tail -f ./start2.sh" >> $1/start2.sh
echo "$INSTALL_DIR/usr/bin/collector --piddir=$INSTALL_DIR/var --datadir=$INSTALL_DIR/opt/data -d 1" > $1/start2.sh

#echo "command: ./start2.sh" > $1/Procfile
chmod 0777 $1/start2.sh
ls -la $1
